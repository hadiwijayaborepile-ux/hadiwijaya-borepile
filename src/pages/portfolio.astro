---
import Layout from '../layouts/Layout.astro';
import PageHero from '../components/PageHero.astro';

interface Project {
  title: string;
  description: string;
  image: string;
}

const API_BASE_URL = import.meta.env.API_URL;
let projects: Project[] = [];

try {
  if (API_BASE_URL) {
    const apiUrl = `${API_BASE_URL}/api/v2/projects`;
    const response = await fetch(apiUrl, { cache: 'no-store' });

    if (response.ok) {
      const apiProjects: any[] = await response.json();
      if (Array.isArray(apiProjects)) {
        projects = apiProjects.map((project: any): Project => ({
          title: project.title,
          description: `Lokasi: ${project.location}.`,
          image: `${API_BASE_URL}/storage/${project.picture_upload}`
        }));
      }
    } else {
      console.error(`[Portfolio] API request failed: ${response.status}.`);
    }
  }
} catch (error) {
  console.error("[Portfolio] Gagal fetch data: ", error);
}

const title = "Portofolio Proyek | Hadiwijaya Pondasi Persada";
const description = "Jelajahi galeri proyek bore pile dan strauss pile yang telah kami kerjakan. Lihat kualitas dan skala pekerjaan kami di berbagai lokasi.";
---

<Layout title={title} description={description}>
  <PageHero 
    title="Portofolio Proyek"
    subtitle="Keahlian kami tercermin dalam setiap proyek yang kami selesaikan. Berikut adalah sebagian dari pekerjaan pondasi bore pile dan strauss pile yang telah kami tangani di berbagai lokasi."
  />

  <section class="portfolio-gallery">
    <div class="container">
      {projects.length > 0 ? (
        <div class="project-grid">
          {projects.map((project) => (
            <div class="project-card">
              <a
                href={project.image}
                class="card-image-wrapper"
                data-fancybox="portfolio"
                data-caption={`<h3>${project.title}</h3><p>${project.description}</p>`}
              >
                <img src={project.image} alt={project.title} loading="lazy" />
              </a>
              <div class="card-content">
                <h3>{project.title}</h3>
                <p>{project.description}</p>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <p class="empty-message">Tidak dapat memuat proyek saat ini. Silakan coba lagi nanti.</p>
      )}
    </div>
  </section>
</Layout>

<style>
  .portfolio-gallery {
    padding: 5rem 0;
    background-color: white;
  }
  .project-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
  }
  .project-card {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    text-align: left;
    display: flex;
    flex-direction: column;
    border: 1px solid #eee;
  }
  .card-image-wrapper {
    width: 100%;
    padding-top: 133.33%; /* Aspect ratio 3:4 */
    position: relative;
    display: block;
  }
  .project-card img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .card-content {
    padding: 1.5rem;
    flex-grow: 1;
  }
  .card-content h3 {
    margin-top: 0;
    font-size: 1.25rem;
    color: var(--secondary-color);
    margin-bottom: 0.5rem;
  }
  .card-content p {
    font-size: 0.95rem;
    color: #666;
    line-height: 1.6;
  }
  .empty-message {
    text-align: center;
    font-size: 1.1rem;
    color: #777;
    padding: 3rem;
  }
</style>
