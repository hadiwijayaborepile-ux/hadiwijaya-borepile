---
import Layout from '../layouts/Layout.astro';

// Use the WordPress REST endpoint from .env (variable name kept for backwards compatibility)
const POSTS_BASE = import.meta.env.WORDPRESS_GRAPHQL_ENDPOINT || import.meta.env.WORDPRESS_REST_ENDPOINT || null;

let allBlogs = [];
if (!POSTS_BASE) {
  console.error('BLOG_ERROR: WORDPRESS REST endpoint not set (WORDPRESS_GRAPHQL_ENDPOINT).');
} else {
  // Paginate through WordPress REST API using page & per_page
  const perPage = 20;
  let page = 1;
  while (true) {
    const url = `${POSTS_BASE}?_embed&per_page=${perPage}&page=${page}`;
    try {
      const res = await fetch(url);
      if (!res.ok) {
        // no more pages or error
        break;
      }
      const posts = await res.json();
      if (!Array.isArray(posts) || posts.length === 0) break;

      // Map to a friendly shape used by templates
      const mapped = posts.map(p => {
        const headline_img = p._embedded && p._embedded['wp:featuredmedia'] && p._embedded['wp:featuredmedia'][0]
          ? p._embedded['wp:featuredmedia'][0].source_url
          : null;
        return {
          slug: p.slug,
          title: p.title?.rendered || '',
          excerpt: p.excerpt?.rendered || '',
          date: p.date,
          headline_img,
        };
      });
      allBlogs.push(...mapped);
      if (posts.length < perPage) break; // last page
      page += 1;
    } catch (err) {
      console.error('Error fetching posts from WordPress REST:', err);
      break;
    }
  }
}

const featuredBlogs = allBlogs.slice(0, 3);
const otherBlogs = allBlogs.slice(3);

const title = "Blog & Artikel | Hadiwijaya Pondasi Persada";
const description = "Dapatkan insight terbaru seputar dunia konstruksi, fondasi, dan teknologi bore pile dari para ahli kami.";
const keywords = [
  "blog konstruksi",
  "artikel bore pile",
  "teknik pengeboran bore pile",
  "manajemen proyek konstruksi",
  "analisis geoteknik",
  "estimasi biaya pondasi",
  "studi kasus pondasi",
  "solusi pondasi tanah sulit",
  "inovasi teknologi konstruksi",
  "pemilihan kontraktor pondasi",
  "kekuatan struktur bangunan",
  "tren industri pondasi",
  "berita fondasi terbaru"
];
---

<Layout title={title} description={description} keywords={keywords}>
  <section class="page-header">
    <h1>Blog & Artikel</h1>
    <p>Insight terbaru seputar dunia konstruksi, fondasi, dan teknologi bore pile dari para ahli kami.</p>
  </section>

  <section class="page-body">
    <div class="container">
      {allBlogs.length > 0 ? (
        <>
          <!-- Featured Articles -->
          {featuredBlogs.length > 0 && (
            <div class="featured-section">
              <h2>Artikel Unggulan</h2>
              <div class="featured-grid">
                {featuredBlogs.map((blog: any) => (
                  <a href={`/blog/${blog.slug}`} class="blog-card">
                    <div class="card-image-wrapper">
                      <img src={blog.headline_img || '/assets/img/hero.jpg'} alt={blog.title} class="card-image" loading="lazy" />
                    </div>
                    <div class="card-content">
                      <p class="card-date">{new Date(blog.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                      <h3 class="card-title">{blog.title}</h3>
                      <span class="card-cta">Baca Selengkapnya &rarr;</span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Other Articles -->
          {otherBlogs.length > 0 && (
            <div class="other-articles-section">
              <h2>Artikel Lainnya</h2>
              <div class="other-articles-list">
                {otherBlogs.map((blog: any) => (
                  <a href={`/blog/${blog.slug}`} class="other-article-item">
                    <div class="other-article-image-wrapper">
                      <img src={blog.headline_img || '/assets/img/hero.jpg'} alt={blog.title} class="other-article-image" loading="lazy" />
                    </div>
                    <div class="other-article-content">
                      <p class="card-date">{new Date(blog.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                      <h3 class="other-article-title">{blog.title}</h3>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}
        </>
      ) : (
        <div class="no-articles-message">
          <h2>Segera Hadir</h2>
          <p>Belum ada artikel yang tersedia saat ini. Kami sedang mempersiapkan konten-konten menarik untuk Anda.</p>
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  .page-header { background-color: var(--secondary-color); color: white; text-align: center; padding: 8rem 2rem 4rem; }
  .page-header h1 { font-size: 3rem; margin: 0; }
  .page-header p { font-size: 1.2rem; max-width: 600px; margin: 0.5rem auto 0; opacity: 0.9; }
  .page-body { padding: 5rem 0; }
  .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
  h2 { font-size: 2.2rem; color: var(--secondary-color); margin-top: 0; margin-bottom: 2rem; text-align: center; }
  .featured-section { margin-bottom: 5rem; }
  .featured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; }
  .blog-card { text-decoration: none; background-color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.07); transition: all 0.3s ease; }
  .blog-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  .card-image-wrapper { height: 200px; }
  .card-image { width: 100%; height: 100%; object-fit: cover; }
  .card-content { padding: 1.5rem; }
  .card-date { font-size: 0.9rem; color: #666; margin: 0 0 0.5rem; }
  .card-title { font-size: 1.25rem; font-weight: 700; color: var(--secondary-color); margin: 0 0 1rem; line-height: 1.4; }
  .card-cta { font-weight: 600; color: var(--primary-color); }
  .blog-card:hover .card-title { color: var(--primary-color); }
  .other-articles-section { }
  .other-articles-list { display: flex; flex-direction: column; gap: 1.5rem; max-width: 800px; margin: 0 auto; }
  .other-article-item { display: grid; grid-template-columns: 150px 1fr; gap: 1.5rem; align-items: center; text-decoration: none; background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; }
  .other-article-item:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
  .other-article-image-wrapper { height: 100px; border-radius: 6px; overflow: hidden; }
  .other-article-image { width: 100%; height: 100%; object-fit: cover; }
  .other-article-title { font-size: 1.15rem; font-weight: 600; color: var(--secondary-color); }
  .other-article-item:hover .other-article-title { color: var(--primary-color); }
  .no-articles-message { text-align: center; padding: 4rem 2rem; background-color: #f7f9fc; border-radius: 12px; }
  .no-articles-message h2 { font-size: 2rem; }
  .no-articles-message p { font-size: 1.2rem; color: #555; max-width: 500px; margin: 0.5rem auto 0; }
  @media (max-width: 768px) { .other-article-item { grid-template-columns: 100px 1fr; } }
</style>
