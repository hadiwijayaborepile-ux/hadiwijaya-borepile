---
import Layout from '../layouts/Layout.astro';

const POSTS_BASE = import.meta.env.WORDPRESS_GRAPHQL_ENDPOINT || import.meta.env.WORDPRESS_REST_ENDPOINT || null;

let allBlogs = [];
if (!POSTS_BASE) {
  console.error('---------------------------------------------------');
  console.error('FATAL: Blog posts could not be fetched for /blog page.');
  console.error('REASON: The WORDPRESS_REST_ENDPOINT environment variable is not set.');
  console.error('ACTION: Please set this variable in your deployment environment.');
  console.error('Example: https://your-wordpress-site.com/wp-json/wp/v2/posts');
  console.error('---------------------------------------------------');
  allBlogs = [];
} else {
  const perPage = 20;
  let page = 1;
  while (true) {
    const url = `${POSTS_BASE}?_embed&per_page=${perPage}&page=${page}`;
    try {
      const res = await fetch(url);
      if (!res.ok) {
        if (page === 1) console.error(`Failed to fetch initial posts from ${url}. Status: ${res.status}`);
        break;
      }
      const posts = await res.json();
      if (!Array.isArray(posts) || posts.length === 0) break;

      const mapped = posts.map(p => {
        const headline_img = p._embedded?.['wp:featuredmedia']?.[0]?.source_url || null;
        let imageFromContent = null;
        if (!headline_img) {
          const match = p.content?.rendered.match(/<img[^>]+src="([^">]+)"/);
          if (match) imageFromContent = match[1];
        }
        return {
          slug: p.slug,
          title: p.title?.rendered || '',
          excerpt: p.excerpt?.rendered || '',
          date: p.date,
          headline_img: headline_img || imageFromContent,
        };
      });
      allBlogs.push(...mapped);
      if (posts.length < perPage) break;
      page += 1;
    } catch (err) {
      console.error(`Error fetching posts from URL: ${url}`, err);
      break;
    }
  }
}

const featuredBlogs = allBlogs.slice(0, 3);
const otherBlogs = allBlogs.slice(3);

const title = "Blog & Artikel | Hadiwijaya Bore Pile";
const description = "Dapatkan insight terbaru seputar dunia konstruksi, fondasi, dan teknologi bore pile dari para ahli kami.";
// Keywords remain the same
---

<Layout title={title} description={description}>
  <section class="page-header">
    <h1>Blog & Artikel</h1>
    <p>Insight terbaru seputar dunia konstruksi, fondasi, dan teknologi bore pile dari para ahli kami.</p>
  </section>

  <section class="page-body">
    <div class="container">
      {allBlogs.length > 0 ? (
        <>
          {featuredBlogs.length > 0 && (
            <div class="featured-section">
              <h2>Artikel Unggulan</h2>
              <div class="featured-grid">
                {featuredBlogs.map((blog: any) => (
                  <a href={`/blog/${blog.slug}`} class="blog-card">
                    <div class="card-image-wrapper">
                      <img src={blog.headline_img || '/assets/img/hero.jpg'} alt={blog.title} class="card-image" loading="lazy" />
                    </div>
                    <div class="card-content">
                      <p class="card-date">{new Date(blog.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                      <h3 class="card-title">{blog.title}</h3>
                      <span class="card-cta">Baca Selengkapnya &rarr;</span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}

          {otherBlogs.length > 0 && (
            <div class="other-articles-section">
              <h2>Artikel Lainnya</h2>
              <div class="other-articles-list">
                {otherBlogs.map((blog: any) => (
                  <a href={`/blog/${blog.slug}`} class="other-article-item">
                    <div class="other-article-image-wrapper">
                      <img src={blog.headline_img || '/assets/img/hero.jpg'} alt={blog.title} class="other-article-image" loading="lazy" />
                    </div>
                    <div class="other-article-content">
                      <p class="card-date">{new Date(blog.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                      <h3 class="other-article-title">{blog.title}</h3>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}
        </>
      ) : (
        <div class="no-articles-message">
          <h2>Segera Hadir</h2>
          <p>Belum ada artikel yang tersedia saat ini. Kami sedang mempersiapkan konten-konten menarik untuk Anda.</p>
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  /* Styles remain the same */
</style>
