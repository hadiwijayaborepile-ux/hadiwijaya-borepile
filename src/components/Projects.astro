---
interface Project {
  title: string;
  description: string;
  image: string;
}

const API_BASE_URL = import.meta.env.API_URL;
let projects: Project[] = [];

try {
  if (API_BASE_URL) {
    const apiUrl = `${API_BASE_URL}/api/v2/projects`;
    const response = await fetch(apiUrl, { cache: 'no-store' });

    if (response.ok) {
      const apiProjects: any[] = await response.json();
      if (Array.isArray(apiProjects)) {
        projects = apiProjects.map((project: any): Project => ({
          title: project.title,
          description: `Lokasi: ${project.location}.`,
          image: `${API_BASE_URL}/storage/${project.picture_upload}`
        }));
      }
    } else {
      console.error(`[Projects] API request failed: ${response.status}.`);
    }
  }
} catch (error) {
  console.error("[Projects] Gagal fetch data: ", error);
}

const visibleProjects = projects.slice(0, 3);
---

<section class="latest-projects">
  <div class="container">
    <h2>Proyek Terbaru Kami</h2>

    {visibleProjects.length > 0 ? (
      <div class="project-grid">
        {visibleProjects.map((project) => (
          <div class="project-card">
            <a
              href={project.image}
              class="card-image-wrapper"
              data-fancybox="projects-homepage"
              data-caption={`<h3>${project.title}</h3><p>${project.description}</p>`}
            >
              <img src={project.image} alt={project.title} loading="lazy" />
            </a>
            <div class="card-content">
              <h3>{project.title}</h3>
              <p>{project.description}</p>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p class="empty-message">Proyek terbaru akan segera ditampilkan di sini.</p>
    )}

    {projects.length > 3 && (
      <div class="cta-container">
        <a href="/portfolio" class="cta-button">
          Lihat Semua Proyek
        </a>
      </div>
    )}
  </div>
</section>

<style>
  .latest-projects { background-color: var(--background-color); text-align: center; padding: 5rem 0; }
  .project-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 3rem; }
  .project-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); text-align: left; display: flex; flex-direction: column; }
  .card-image-wrapper { width: 100%; padding-top: 133.33%; position: relative; display: block; border-radius: 12px 12px 0 0; }
  .project-card img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
  .card-content { padding: 1.5rem; flex-grow: 1; }
  .card-content h3 { margin-top: 0; font-size: 1.25rem; color: var(--secondary-color); margin-bottom: 0.5rem; }
  .card-content p { font-size: 0.95rem; color: #666; line-height: 1.6; }
  .cta-container { margin-top: 3rem; text-align: center; }
  .cta-button { 
    display: inline-block;
    background-color: white; 
    color: var(--primary-color); 
    border: 2px solid var(--primary-color); 
    padding: 0.8rem 2.5rem; 
    font-size: 1rem; 
    font-weight: 700; 
    border-radius: 50px; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    text-decoration: none; 
  }
  .cta-button:hover { 
    background-color: var(--primary-color); 
    color: white; 
    transform: translateY(-3px); 
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); 
  }
  .empty-message {
    text-align: center;
    font-size: 1.1rem;
    color: #777;
    padding: 2rem;
  }

  @media (max-width: 768px) {
    .latest-projects { padding: 3rem 0; }
    .latest-projects h2 {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .project-grid { grid-template-columns: 1fr; gap: 1.5rem; }
  }
</style>
